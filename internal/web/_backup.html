{{define "backup"}}

<br/>
<span>
    Run backup for "{{.CurrRepoName}}".
</span>
<br/>
<br/>

<div class="errors" aria-hidden="true" style="display: none;">
    <ul class="errors alert alert-danger">

    </ul>
</div>

<div class="table-responsive">
    <table class="table table-sm table-striped">
        <tbody>

        <tr>
            <td>&nbsp;
                <!-- ajax will specify method="DELETE" -->
                <form action="/runbackup" method="post">
                    <input type="hidden" name="repo" value="{{$.CurrRepoName}}">
                    <button type="submit" class="btn btn-success run-backup">Run Backup</button>
                </form>
            </td>
        </tr>

        </tbody>
    </table>
</div>



<div id="progress-container">
</div>

<script>
    var timeout = 60000; // milliseconds

    function doPoll() {
        $.ajax({
            url: "/status?timeout=" + timeout,
            timeout: timeout,
            success: function (response) {
                console.log('success: ' + JSON.stringify(response));
                var repo = response['RepoName'];
                var percentDone = response["PercentDone"];
                var percentDoneString =  percentDone + '%';

                findOrCreateProgressBar(repo, percentDone, percentDoneString);

                setTimeout(doPoll, 500);
            },
            error: function (xhr, status, error) {
                console.log('error, xhr: ' + JSON.stringify(xhr) + ', status: ' + JSON.stringify(status) + ', error: ' + JSON.stringify(error));
                setTimeout(doPoll, 10000);
            }
        });
    }

    $(document).ready(function(){
        doPoll();
    });


    function findOrCreateProgressBar(repo, percentDone, percentDoneString) {
        // TODO: ensure repo names have no spaces, can always serve as ids
        var pbarId = 'progress-bar-' + repo;
        var pbar = $('#' + pbarId);
        if (pbar.length === 0) {
            console.log("did not find " + pbarId);

            var container = $('#progress-container');
            var holder = $('<div class="progress"></div><br/>');

            pbar = $('<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">10%</div>');
            $(pbar).attr('id', pbarId);

            $(holder).append(pbar);
            $(container).append(holder);
        }

        $(pbar).attr('aria-valuenow', percentDone).css('width', percentDoneString).text(percentDoneString);
    }


</script>



<script>
    $(function () {
        $('.run-backup').click(function (e) {
            e.preventDefault();

            var form = $(this).closest('form');
            var errorsDiv = $('div.errors')[0];
            var errorsUl = $(errorsDiv).find('ul.errors')[0];

            console.log('errorsDiv: ' + JSON.stringify(errorsDiv));
            console.log('errorsUl: ' + JSON.stringify(errorsUl));
            console.log("serialize: " + $(form).serialize());

            $.ajax({
                type: "POST",
                url: "/runbackup?" + $(form).serialize(),
                success: function (response) {
                    $(errorsUl).empty();
                    $(errorsDiv).hide();

                    eval(response.on_success);

                    // reload page
                    // TODO: animate change rather than reload
                    window.location.href = window.location.href;
                },
                error: function (xhr, status, error) {
                    console.log('got xhr: ' + xhr + ', status: ' + status + ', error: ' + error);
                    console.log('error: got xhr.responseText: ' + xhr.responseText);
                    console.log('error: got xhr.responseJSON: ' + xhr.responseJSON);

                    // clear previous errors, if any
                    $(errorsUl).empty();
                    $.each(xhr.responseJSON, function (key, value) {
                        li = '<li>' + value + '</li>'; //showing only the first error.
                        $(errorsUl).append(li);
                    });
                    $(errorsDiv).show();
                }
            });
            return false;
        });
    });
</script>


{{end}}
