{{define "backup"}}

<br/>

<div>
    Run backup for <span class="font-weight-bold">{{.CurrRepoName}}</span>.
</div>
<br/>
<br/>

<div class="alert alert-danger fade show" role="alert" style="display: none;">
    <button type="button" class="close" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
    <strong id="ajax-error">placeholder!</strong>
</div>

<div>
    <!-- ajax will specify method="DELETE" -->
    <form action="/runbackup" method="post">
        <input type="hidden" name="repo" value="{{$.CurrRepoName}}">
        <button type="submit" class="btn btn-success run-backup">Backup Now</button>
    </form>
</div>
<br/>
<br/>


<div id="progress-container">
</div>

<script>
    // prevent close button from removing alert div from the DOM so we can reuse it.
    // Unfortunately, this seems to also disable fade in/out from working.
    // https://stackoverflow.com/questions/8965018/dynamically-creating-bootstrap-css-alert-messages
    $('.alert .close').on('click', function(e) {
        $(this).parent().hide();
    });

    // NB: errorMap (xhr.responseJSON) is only present if the server has explicitly
    // set application/json and wrote a JSON response.
    function showAjaxErrors(errorMap) {
        var errorSpan = $('#ajax-error');
        var errorsDiv = $(errorSpan).closest('div');

        // clear previous errors, if any
        $(errorSpan).empty();

        $.each(errorMap, function (key, value) {
            $(errorSpan).append(value);
        });

        $(errorsDiv).show();
    }
</script>

<script>
    var timeout = 60000; // milliseconds

    function doPoll() {
        $.ajax({
            url: "/status?timeout=" + timeout,
            timeout: timeout,
            success: function (response) {
                console.log('success: ' + JSON.stringify(response));
                var repo = response['RepoName'];
                var percentDone = response["PercentDone"];
                var percentDoneString =  percentDone + '%';
                var statusMsg = response['StatusMsg'];
                var indeterminate = response['Indeterminate'];

                updateOrCreateProgressBar(repo, percentDone, percentDoneString, statusMsg, indeterminate);
                setTimeout(doPoll, 500);
            },
            error: function (xhr, status, error) {
                console.log('error, xhr: ' + JSON.stringify(xhr) + ', status: ' + JSON.stringify(status) + ', error: ' + JSON.stringify(error));
                showAjaxErrors(xhr.responseJSON);
                setTimeout(doPoll, 2000);
            }
        });
    }

    $(document).ready(function(){
        doPoll();
    });

    function updateOrCreateProgressBar(repo, percentDone, percentDoneString, statusMsg, indeterminate) {
        // TODO: ensure repo names have no spaces, can always serve as ids
        var pbarId = 'progress-bar-' + repo;
        var statusSpanId = 'status-msg-' + repo;
        var pbar = $('#' + pbarId);
        if (pbar.length === 0) {
            console.log("did not find " + pbarId);

            var container = $('#progress-container');
            $(container).append($('<div><span>' + repo + '</span></div><div><span id="' + statusSpanId + '"></span></div>'));
            var holder = $('<div class="progress"></div><br/>');

            pbar = $('<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>');
            $(pbar).attr('id', pbarId);

            $(holder).append(pbar);
            $(container).append(holder);
        }

        if (indeterminate) {
            $('#' + statusSpanId).text("");
            $(pbar).addClass('progress-bar-striped progress-bar-animated');
            $(pbar).attr('aria-valuenow', percentDone).css('width', '100%').text(statusMsg);
        } else {
            $('#' + statusSpanId).text("");
//            $('#' + statusSpanId).text(statusMsg);
            $(pbar).removeClass('progress-bar-striped progress-bar-animated');
            $(pbar).attr('aria-valuenow', percentDone).css('width', percentDoneString).text(statusMsg + ": " + percentDoneString);
        }

    }
</script>

<script>
    $(function () {
        $('.run-backup').click(function (e) {
            e.preventDefault();

            var form = $(this).closest('form');
            var errorSpan = $('#ajax-error');
            var errorsDiv = $(errorSpan).closest('div');

            $.ajax({
                type: "POST",
                url: "/runbackup?" + $(form).serialize(),
                success: function (response) {
                    $(errorsUl).empty();
                    $(errorsDiv).hide();

                    eval(response.on_success);

                    // reload page
                    // TODO: animate change rather than reload
                    window.location.href = window.location.href;
                },
                error: function (xhr, status, error) {
                    console.log('got xhr: ' + xhr + ', status: ' + status + ', error: ' + error);
                    console.log('error: got xhr.responseText: ' + xhr.responseText);
                    console.log('error: got xhr.responseJSON: ' + xhr.responseJSON);

                    showAjaxErrors(xhr.responseJSON);
                }
            });
            return false;
        });
    });
</script>


{{end}}
